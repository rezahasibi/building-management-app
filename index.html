<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت ساختمان و حسابداری</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* تعیین فونت فارسی برای کل برنامه */
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f4f7f9;
        }
        /* استایل سفارشی برای دکمه‌ها و فرم‌ها */
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .btn-primary {
            background-color: #0d9488; /* Teal 600 */
            color: white;
            font-weight: 600;
            border-radius: 8px;
            padding: 0.65rem 1.25rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #0f766e; /* Teal 700 */
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            border-color: #0d9488;
            outline: none;
        }
        .tab-button.active {
            border-bottom: 3px solid #0d9488;
            color: #0d9488;
            font-weight: 600;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="text-xl font-bold text-gray-700">درحال بارگذاری...</div>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header / Navigation Bar -->
        <header id="app-header" class="mb-6 flex justify-between items-center text-gray-800">
            <h1 class="text-2xl font-bold text-teal-700">مدیریت ساختمان</h1>
            <div id="auth-info" class="flex items-center space-x-2 space-x-reverse">
                <!-- User ID will be displayed here -->
            </div>
            <button id="logout-button" class="btn-primary hidden" onclick="handleLogout()">
                خروج
            </button>
        </header>

        <!-- Auth View (Login/Signup) -->
        <div id="auth-view" class="max-w-md mx-auto card">
            <h2 class="text-xl font-bold mb-6 text-center text-gray-700" id="auth-title">ورود به سیستم</h2>

            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700 mb-1">ایمیل</label>
                    <input type="email" id="auth-email" class="input-field" placeholder="ایمیل خود را وارد کنید" required>
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700 mb-1">رمز عبور</label>
                    <input type="password" id="auth-password" class="input-field" placeholder="رمز عبور" required>
                </div>
                <div id="auth-error" class="text-red-500 text-sm hidden"></div>
                
                <button type="submit" class="btn-primary w-full" id="auth-submit-btn">ورود</button>
            </form>

            <p class="mt-4 text-center text-sm">
                <button id="toggle-auth-mode" class="text-teal-600 hover:text-teal-800 transition">
                    حساب کاربری ندارید؟ ثبت نام کنید
                </button>
            </p>
        </div>

        <!-- Main Dashboard View -->
        <div id="main-view" class="hidden">
            
            <!-- Tab Navigation -->
            <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-lg shadow-md">
                <button class="tab-button p-3 flex-1 text-center text-gray-600 hover:bg-gray-50 active" data-tab="dashboard">داشبورد</button>
                <button class="tab-button p-3 flex-1 text-center text-gray-600 hover:bg-gray-50" data-tab="units">واحدها</button>
                <button class="tab-button p-3 flex-1 text-center text-gray-600 hover:bg-gray-50" data-tab="transactions">تراکنش‌ها</button>
            </div>

            <!-- Content Container -->
            <div id="tab-content">
                
                <!-- 1. Dashboard Tab -->
                <div id="dashboard-tab" class="card space-y-6">
                    <h3 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">خلاصه وضعیت مالی</h3>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                        <div class="p-4 bg-blue-100 rounded-lg">
                            <p class="text-sm text-blue-700">کل درآمد (شارژها)</p>
                            <p id="total-income" class="text-2xl font-bold text-blue-900 mt-1">۰ ریال</p>
                        </div>
                        <div class="p-4 bg-red-100 rounded-lg">
                            <p class="text-sm text-red-700">کل هزینه‌ها</p>
                            <p id="total-expense" class="text-2xl font-bold text-red-900 mt-1">۰ ریال</p>
                        </div>
                        <div class="p-4 bg-green-100 rounded-lg">
                            <p class="text-sm text-green-700">موجودی صندوق</p>
                            <p id="current-balance" class="text-2xl font-bold mt-1" data-color="text-green-900">۰ ریال</p>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h4 class="font-semibold text-lg mb-2 text-gray-700">بدهی واحدها</h4>
                        <ul id="unit-debt-list" class="space-y-2">
                            <!-- Unit debt items will be listed here -->
                        </ul>
                    </div>
                </div>

                <!-- 2. Units Tab -->
                <div id="units-tab" class="card space-y-6 hidden">
                    <h3 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">مدیریت واحدها</h3>
                    
                    <!-- Add Unit Form -->
                    <form id="add-unit-form" class="p-4 border rounded-lg bg-gray-50 space-y-3">
                        <h4 class="font-semibold text-gray-700">افزودن واحد جدید</h4>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <input type="number" id="unit-number" class="input-field flex-1" placeholder="شماره واحد (مثلاً ۱۰۱)" required>
                            <input type="number" id="unit-monthly-fee" class="input-field flex-1" placeholder="شارژ ماهانه (ریال)" required>
                            <button type="submit" class="btn-primary sm:w-auto">ثبت واحد</button>
                        </div>
                    </form>

                    <!-- Units List -->
                    <div class="mt-6">
                        <h4 class="font-semibold text-lg mb-2 text-gray-700">لیست واحدهای ثبت شده</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead>
                                    <tr class="bg-gray-100 text-right text-sm font-medium text-gray-600">
                                        <th class="py-3 px-4 border-b">شماره واحد</th>
                                        <th class="py-3 px-4 border-b">شارژ ماهانه</th>
                                        <th class="py-3 px-4 border-b">وضعیت (بدهی)</th>
                                        <th class="py-3 px-4 border-b">عملیات</th>
                                    </tr>
                                </thead>
                                <tbody id="units-table-body">
                                    <!-- Unit rows will be listed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. Transactions Tab -->
                <div id="transactions-tab" class="card space-y-6 hidden">
                    <h3 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">ثبت و مدیریت تراکنش‌ها</h3>
                    
                    <!-- Add Transaction Form -->
                    <form id="add-transaction-form" class="p-4 border rounded-lg bg-gray-50 space-y-3">
                        <h4 class="font-semibold text-gray-700">ثبت تراکنش جدید</h4>
                        
                        <select id="transaction-type" class="input-field" required>
                            <option value="">نوع تراکنش را انتخاب کنید</option>
                            <option value="income">دریافت شارژ/درآمد</option>
                            <option value="expense">پرداخت هزینه/هزینه مشترک</option>
                        </select>

                        <div id="unit-select-container" class="hidden">
                            <select id="transaction-unit-id" class="input-field">
                                <option value="">واحد دریافت کننده/پرداخت کننده شارژ (اختیاری)</option>
                                <!-- Unit options will be populated here -->
                            </select>
                        </div>

                        <input type="number" id="transaction-amount" class="input-field" placeholder="مبلغ (ریال)" required>
                        <input type="text" id="transaction-description" class="input-field" placeholder="شرح تراکنش (مثلاً قبض آب، شارژ ۱۰۱)" required>
                        <input type="date" id="transaction-date" class="input-field" required>
                        
                        <button type="submit" class="btn-primary w-full">ثبت تراکنش</button>
                    </form>

                    <!-- Transactions List -->
                    <div class="mt-6">
                        <h4 class="font-semibold text-lg mb-2 text-gray-700">لیست تراکنش‌ها</h4>
                        <ul id="transactions-list" class="space-y-3">
                            <!-- Transaction items will be listed here -->
                        </ul>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script type="module">
        // ----------------------------------------------------------------------
        // بخش ۱: راه‌اندازی و اتصال به فایربیس
        // ----------------------------------------------------------------------
        
        // ماژول‌های فایربیس مورد نیاز را وارد کنید
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // متغیرهای گلوبال فایربیس از محیط کانواس
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, userId;
        let isAuthReady = false;

        const firebaseConfig_Injected = {
            apiKey: "AIzaSyDslytRTaMOxTeGeuteMoBd_qy2ludPd_Q",
            authDomain: "building-management-app-92977.firebaseapp.com",
            projectId: "building-management-app-92977",
            storageBucket: "building-management-app-92977.firebasestorage.app",
            messagingSenderId: "24895271205",
            appId: "1:24895271205:web:50eeffdee3d71ebe962acc"
        };
        
        // استفاده از پیکربندی تزریق شده یا پیکربندی شما
        const finalConfig = Object.keys(firebaseConfig).length > 0 ? firebaseConfig : firebaseConfig_Injected;


        // ----------------------------------------------------------------------
        // توابع کمکی UI
        // ----------------------------------------------------------------------

        function showLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        }

        function showView(viewId) {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fa-IR', { style: 'decimal', currency: 'IRR' }).format(amount) + ' ریال';
        }

        function displayError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => errorElement.classList.add('hidden'), 5000);
        }

        // ----------------------------------------------------------------------
        // بخش ۲: احراز هویت (Authentication)
        // ----------------------------------------------------------------------

        async function initializeFirebase() {
            showLoading(true);
            try {
                // مقداردهی اولیه برنامه
                app = initializeApp(finalConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // تنظیم شنونده تغییر وضعیت احراز هویت
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('auth-info').innerHTML = `
                            <span class="text-sm font-medium text-gray-600">ID: ${userId}</span>
                        `;
                        document.getElementById('logout-button').classList.remove('hidden');
                        showView('main-view');
                        // شروع بارگذاری داده‌های فایربیس
                        setupFirestoreListeners();
                    } else {
                        userId = null;
                        document.getElementById('auth-info').innerHTML = '';
                        document.getElementById('logout-button').classList.add('hidden');
                        showView('auth-view');
                    }
                    isAuthReady = true;
                    showLoading(false);
                });
                
                // تلاش برای ورود با توکن سفارشی (اگر فراهم شده باشد) یا ورود ناشناس
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("خطا در راه‌اندازی فایربیس:", error);
                showLoading(false);
                displayError('auth-error', 'خطا در اتصال به سرور: ' + error.message);
            }
        }

        // مدیریت فرم ورود و ثبت نام
        let isLoginMode = true;

        document.getElementById('toggle-auth-mode').addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('auth-title');
            const button = document.getElementById('auth-submit-btn');
            const toggleText = document.getElementById('toggle-auth-mode');
            
            if (isLoginMode) {
                title.textContent = 'ورود به سیستم';
                button.textContent = 'ورود';
                toggleText.textContent = 'حساب کاربری ندارید؟ ثبت نام کنید';
            } else {
                title.textContent = 'ثبت نام کاربر جدید';
                button.textContent = 'ثبت نام';
                toggleText.textContent = 'قبلاً ثبت نام کرده‌اید؟ وارد شوید';
            }
        });

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                let errorMessage = 'خطای نامشخص.';
                if (error.code === 'auth/invalid-email') errorMessage = 'فرمت ایمیل نامعتبر است.';
                else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') errorMessage = 'ایمیل یا رمز عبور اشتباه است.';
                else if (error.code === 'auth/email-already-in-use') errorMessage = 'این ایمیل قبلاً ثبت نام شده است.';
                else if (error.code === 'auth/weak-password') errorMessage = 'رمز عبور باید حداقل ۶ کاراکتر باشد.';
                
                displayError('auth-error', 'خطا: ' + errorMessage);
                console.error("Auth Error:", error);
            } finally {
                showLoading(false);
            }
        });

        function handleLogout() {
            signOut(auth).catch(error => {
                console.error("خطا در خروج:", error);
            });
        }


        // ----------------------------------------------------------------------
        // بخش ۳: فایربیس و مدیریت داده‌ها (Firestore)
        // ----------------------------------------------------------------------
        
        let units = []; // لیست واحدهای ساختمان
        let transactions = []; // لیست تراکنش‌های ساختمان

        // مسیرهای Firestore
        function getCollectionPath(collectionName) {
            // از آنجایی که این یک اپ مدیریتی ساختمان است و اطلاعات باید بین همه کاربران آن ساختمان مشترک باشد،
            // ما از مسیر عمومی (public data) استفاده می‌کنیم.
            return `/artifacts/${appId}/public/data/${collectionName}`;
        }
        
        // تنظیم شنونده‌های بلادرنگ Firestore
        function setupFirestoreListeners() {
            if (!db || !isAuthReady || !userId) return;

            // 1. شنونده برای واحدها
            const unitsQuery = query(collection(db, getCollectionPath('units')));
            onSnapshot(unitsQuery, (snapshot) => {
                units = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("واحدها به روز شدند:", units.length);
                renderUnits();
                renderTransactionUnitOptions();
                calculateDashboardMetrics();
            }, (error) => {
                console.error("خطا در دریافت واحدها:", error);
            });

            // 2. شنونده برای تراکنش‌ها
            const transactionsQuery = query(collection(db, getCollectionPath('transactions')), orderBy("date", "desc"));
            onSnapshot(transactionsQuery, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("تراکنش‌ها به روز شدند:", transactions.length);
                renderTransactions();
                calculateDashboardMetrics();
            }, (error) => {
                console.error("خطا در دریافت تراکنش‌ها:", error);
            });
        }

        // ----------------------------------------------------------------------
        // بخش ۴: عملیات CRUD برای واحدها
        // ----------------------------------------------------------------------

        document.getElementById('add-unit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return displayError('units-tab', 'لطفاً ابتدا وارد شوید.');
            showLoading(true);

            const number = parseInt(document.getElementById('unit-number').value);
            const monthlyFee = parseInt(document.getElementById('unit-monthly-fee').value);

            if (units.some(u => u.number === number)) {
                displayError('units-tab', 'این شماره واحد قبلاً ثبت شده است.');
                showLoading(false);
                return;
            }

            try {
                await addDoc(collection(db, getCollectionPath('units')), {
                    number: number,
                    monthlyFee: monthlyFee,
                    createdAt: new Date().toISOString(),
                    createdBy: userId
                });
                // فرم را پاک کنید
                document.getElementById('add-unit-form').reset();
            } catch (error) {
                console.error("خطا در ثبت واحد:", error);
                displayError('units-tab', 'خطا در ثبت واحد: ' + error.message);
            } finally {
                showLoading(false);
            }
        });
        
        async function deleteUnit(unitId) {
            if (!confirm("آیا مطمئن هستید که می‌خواهید این واحد را حذف کنید؟ (تمام سوابق مالی مرتبط باقی می‌ماند)")) {
                return;
            }
            showLoading(true);
            try {
                // توجه: در یک سیستم واقعی باید ابتدا تراکنش‌های مرتبط را هم پاک یا غیرفعال کرد.
                await deleteDoc(doc(db, getCollectionPath('units'), unitId));
            } catch (error) {
                console.error("خطا در حذف واحد:", error);
            } finally {
                showLoading(false);
            }
        }


        // ----------------------------------------------------------------------
        // بخش ۵: عملیات CRUD برای تراکنش‌ها
        // ----------------------------------------------------------------------

        // نمایش یا پنهان کردن فیلد انتخاب واحد بر اساس نوع تراکنش
        document.getElementById('transaction-type').addEventListener('change', (e) => {
            const container = document.getElementById('unit-select-container');
            if (e.target.value === 'income') {
                container.classList.remove('hidden');
                document.getElementById('transaction-unit-id').setAttribute('required', 'required');
            } else {
                container.classList.add('hidden');
                document.getElementById('transaction-unit-id').removeAttribute('required');
            }
        });

        document.getElementById('add-transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return displayError('transactions-tab', 'لطفاً ابتدا وارد شوید.');
            showLoading(true);

            const type = document.getElementById('transaction-type').value;
            const amount = parseInt(document.getElementById('transaction-amount').value);
            const description = document.getElementById('transaction-description').value;
            const dateStr = document.getElementById('transaction-date').value;
            const unitId = type === 'income' ? document.getElementById('transaction-unit-id').value : '';

            try {
                await addDoc(collection(db, getCollectionPath('transactions')), {
                    type: type, // 'income' or 'expense'
                    amount: amount,
                    description: description,
                    date: dateStr, // تاریخ به صورت رشته YYYY-MM-DD ذخیره می‌شود
                    unitId: unitId || null, // فقط برای 'income' پر می‌شود
                    createdAt: new Date().toISOString(),
                    createdBy: userId
                });
                // فرم را پاک کنید
                document.getElementById('add-transaction-form').reset();
                document.getElementById('unit-select-container').classList.add('hidden'); // پنهان کردن مجدد واحد
            } catch (error) {
                console.error("خطا در ثبت تراکنش:", error);
                displayError('transactions-tab', 'خطا در ثبت تراکنش: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        async function deleteTransaction(transactionId) {
            if (!confirm("آیا مطمئن هستید که می‌خواهید این تراکنش را حذف کنید؟")) {
                return;
            }
            showLoading(true);
            try {
                await deleteDoc(doc(db, getCollectionPath('transactions'), transactionId));
            } catch (error) {
                console.error("خطا در حذف تراکنش:", error);
            } finally {
                showLoading(false);
            }
        }

        // ----------------------------------------------------------------------
        // بخش ۶: رندرینگ UI و محاسبه داشبورد
        // ----------------------------------------------------------------------
        
        // محاسبه بدهی واحدها و معیارهای داشبورد
        function calculateDashboardMetrics() {
            let totalIncome = 0;
            let totalExpense = 0;
            
            // 1. محاسبه کل درآمد و هزینه
            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else if (t.type === 'expense') {
                    totalExpense += t.amount;
                }
            });

            const currentBalance = totalIncome - totalExpense;

            // 2. محاسبه بدهی برای هر واحد
            const unitDebts = {};
            units.forEach(unit => {
                unitDebts[unit.id] = unit.monthlyFee * 3; // فرض می‌کنیم شارژ ۳ ماهه بدهی اولیه است (مثال ساده)
            });

            // کسر تراکنش‌های درآمدی از بدهی واحدها
            transactions.filter(t => t.type === 'income' && t.unitId).forEach(t => {
                if (unitDebts[t.unitId] !== undefined) {
                    unitDebts[t.unitId] -= t.amount;
                }
            });
            
            // 3. نمایش در داشبورد
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
            
            const balanceElement = document.getElementById('current-balance');
            balanceElement.textContent = formatCurrency(currentBalance);
            balanceElement.classList.remove('text-green-900', 'text-red-900');
            balanceElement.classList.add(currentBalance >= 0 ? 'text-green-900' : 'text-red-900');
            
            // 4. رندر لیست بدهی واحدها
            const debtListElement = document.getElementById('unit-debt-list');
            debtListElement.innerHTML = '';
            
            units.sort((a, b) => a.number - b.number).forEach(unit => {
                const debt = unitDebts[unit.id] || 0;
                const statusClass = debt > 0 ? 'text-red-600' : (debt < 0 ? 'text-green-600' : 'text-gray-600');
                const statusText = debt > 0 ? 'بدهکار' : (debt < 0 ? 'بستانکار' : 'تسویه');
                const debtText = debt !== 0 ? formatCurrency(Math.abs(debt)) : 'صفر';
                
                debtListElement.innerHTML += `
                    <li class="flex justify-between items-center p-3 bg-white rounded-lg border border-gray-200">
                        <span class="font-bold text-gray-700">واحد ${unit.number}</span>
                        <span class="${statusClass} font-semibold">
                            ${statusText}: ${debtText}
                        </span>
                    </li>
                `;
            });
        }

        // رندر لیست واحدها در تب واحدها
        function renderUnits() {
            const tableBody = document.getElementById('units-table-body');
            tableBody.innerHTML = '';

            units.sort((a, b) => a.number - b.number).forEach(unit => {
                tableBody.innerHTML += `
                    <tr class="text-right border-b hover:bg-gray-50">
                        <td class="py-3 px-4 text-gray-800 font-semibold">${unit.number}</td>
                        <td class="py-3 px-4">${formatCurrency(unit.monthlyFee)}</td>
                        <td class="py-3 px-4 text-sm text-gray-500">
                            <!-- وضعیت بدهی از محاسبه داشبورد می‌آید -->
                            بررسی در داشبورد
                        </td>
                        <td class="py-3 px-4">
                            <button onclick="deleteUnit('${unit.id}')" class="text-red-500 hover:text-red-700 text-sm">حذف</button>
                        </td>
                    </tr>
                `;
            });
        }

        // رندر لیست تراکنش‌ها در تب تراکنش‌ها
        function renderTransactions() {
            const listElement = document.getElementById('transactions-list');
            listElement.innerHTML = '';
            
            transactions.forEach(t => {
                const isIncome = t.type === 'income';
                const typeClass = isIncome ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                const typeText = isIncome ? 'درآمد' : 'هزینه';
                const unitInfo = t.unitId 
                    ? ` (واحد ${units.find(u => u.id === t.unitId)?.number || 'ناشناس'})` 
                    : '';
                
                listElement.innerHTML += `
                    <li class="card p-4 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-gray-800">${t.description}</p>
                            <p class="text-sm text-gray-500">${t.date}</p>
                        </div>
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${typeClass}">
                                ${typeText} ${unitInfo}
                            </span>
                            <span class="font-bold ${isIncome ? 'text-green-600' : 'text-red-600'}">
                                ${formatCurrency(t.amount)}
                            </span>
                            <button onclick="deleteTransaction('${t.id}')" class="text-red-400 hover:text-red-600 text-sm">حذف</button>
                        </div>
                    </li>
                `;
            });
        }
        
        // پر کردن فیلد انتخاب واحد در فرم تراکنش
        function renderTransactionUnitOptions() {
            const selectElement = document.getElementById('transaction-unit-id');
            const currentValue = selectElement.value; // حفظ مقدار انتخابی کاربر
            selectElement.innerHTML = '<option value="">واحد دریافت کننده/پرداخت کننده شارژ (اختیاری)</option>';
            
            units.sort((a, b) => a.number - b.number).forEach(unit => {
                const selected = unit.id === currentValue ? 'selected' : '';
                selectElement.innerHTML += `<option value="${unit.id}" ${selected}>واحد ${unit.number} (شارژ: ${formatCurrency(unit.monthlyFee)})</option>`;
            });
        }


        // ----------------------------------------------------------------------
        // بخش ۷: مدیریت تب‌ها و راه‌اندازی
        // ----------------------------------------------------------------------

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('data-tab') === tabName) {
                    button.classList.add('active');
                }
            });
            document.getElementById('dashboard-tab').classList.add('hidden');
            document.getElementById('units-tab').classList.add('hidden');
            document.getElementById('transactions-tab').classList.add('hidden');
            
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
        }

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                switchTab(e.target.getAttribute('data-tab'));
            });
        });

        // اجرای تابع راه‌اندازی اصلی
        window.onload = initializeFirebase;

        // قرار دادن توابع در Global Scope برای استفاده در HTML (مثل onclick)
        window.handleLogout = handleLogout;
        window.deleteUnit = deleteUnit;
        window.deleteTransaction = deleteTransaction;

    </script>
</body>
</html>
