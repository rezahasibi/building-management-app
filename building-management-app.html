<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ø®ØªÙ…Ø§Ù†</title>
    <!-- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Tailwind CSS Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ§ÛŒÙ„â€ŒØ¯Ù‡ÛŒ Ù…Ø¯Ø±Ù† Ùˆ Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÙØ§Ø±Ø´ÛŒ Tailwind Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙÙˆÙ†Øª Ùˆ RTL -->
    <style>
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-Variable-font-VF.woff2') format('woff2');
            font-weight: 100 900;
            font-style: normal;
        }
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
        .text-input {
            margin-top: 4px;
            display: block;
            width: 100%;
            border-radius: 6px;
            border-color: #d1d5db;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            padding: 8px;
            border-width: 1px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="loading-spinner" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
        <span class="text-white mr-4">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
    </div>

    <!-- Ù‡Ø¯Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ -->
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ø®ØªÙ…Ø§Ù†</h1>
            <div id="user-info" class="flex items-center space-x-4 space-x-reverse">
                <span id="user-display" class="text-sm font-medium text-gray-600 hidden"></span>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 hidden">
                    Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>
    </header>

    <!-- Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ù…Ø­ØªÙˆØ§ -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… -->
        <div id="system-message-box" class="hidden p-4 mb-4 rounded-lg text-sm font-medium" role="alert"></div>
        
        <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ ØªØ´Ø®ÛŒØµ Ù†Ù‚Ø´ (Ù…Ø¯ÛŒØ± ÛŒØ§ Ø³Ø§Ú©Ù†) -->
        <div id="role-selection-view" class="max-w-lg mx-auto bg-white p-8 rounded-xl shadow-2xl transition duration-500 transform scale-100">
            <h2 class="text-3xl font-extrabold text-center mb-8 text-indigo-800">Ù†Ù‚Ø´ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Ø¯Ú©Ù…Ù‡ ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ± -->
                <div class="bg-indigo-50 p-6 rounded-xl shadow-md hover:shadow-lg transition duration-300 cursor-pointer" id="select-admin">
                    <div class="text-center">
                        <span class="text-4xl">ğŸ‘¨â€ğŸ’¼</span>
                        <h3 class="mt-4 text-xl font-bold text-indigo-700">Ù…Ø¯ÛŒØ± Ø³Ø§Ø®ØªÙ…Ø§Ù†</h3>
                        <p class="text-sm text-gray-600 mt-2">Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒØŒ ÙˆØ§Ø­Ø¯Ù‡Ø§ Ùˆ Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ú©Ø§Ù…Ù„.</p>
                    </div>
                </div>
                <!-- Ø¯Ú©Ù…Ù‡ ÙˆØ±ÙˆØ¯ Ø³Ø§Ú©Ù† -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-md hover:shadow-lg transition duration-300 cursor-pointer" id="select-resident">
                    <div class="text-center">
                        <span class="text-4xl">ğŸ </span>
                        <h3 class="mt-4 text-xl font-bold text-gray-700">Ø³Ø§Ú©Ù†/Ù…Ø§Ù„Ú©</h3>
                        <p class="text-sm text-gray-600 mt-2">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø´Ø§Ø±Ú˜Ù‡Ø§ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ§Ø­Ø¯ Ø®ÙˆØ¯.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ØµÙØ­Ù‡ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù…Ø¯ÛŒØ± -->
        <div id="admin-auth-view" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl hidden">
            <h2 class="text-2xl font-bold text-center mb-6 text-indigo-700">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±</h2>
            <p class="text-sm text-gray-500 text-center mb-4">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´Ù…Ø§ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø­ÛŒØ· Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù†Ù‡Ø§ÛŒÛŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</p>
            <button id="sign-in-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg">
                ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¯ÛŒØ±
            </button>
            <button id="back-to-role-select" class="w-full mt-3 text-indigo-500 hover:text-indigo-700 transition duration-300">
                Ø¨Ø§Ø²Ú¯Ø´Øª
            </button>
        </div>
        
        <!-- Ù†Ù…Ø§ÛŒ Ù…Ø¯ÛŒØ± (Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ù…Ù„) -->
        <div id="admin-dashboard-view" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ (Ù…Ù†ÙˆÛŒ Ù…Ø¯ÛŒØ±ÛŒØª) -->
                <aside class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-full">
                    <nav class="space-y-2">
                        <button data-view="finance" class="menu-button w-full text-right py-3 px-4 rounded-lg text-lg font-medium bg-indigo-50 text-indigo-700 hover:bg-indigo-100 transition duration-150">
                            ğŸ’° Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ùˆ Ù…Ø§Ù„ÛŒ
                        </button>
                        <button data-view="units" class="menu-button w-full text-right py-3 px-4 rounded-lg text-lg font-medium text-gray-600 hover:bg-gray-50 transition duration-150">
                            ğŸ¢ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ø­Ø¯Ù‡Ø§ Ùˆ Ø³Ø§Ú©Ù†ÛŒÙ†
                        </button>
                        <button data-view="reports" class="menu-button w-full text-right py-3 px-4 rounded-lg text-lg font-medium text-gray-600 hover:bg-gray-50 transition duration-150">
                            ğŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ùˆ Ø¢Ù…Ø§Ø± Ø¨Ø¯Ù‡ÛŒ
                        </button>
                    </nav>
                    <p class="mt-6 p-3 bg-gray-50 rounded-lg text-sm text-gray-500 border-r-4 border-indigo-400">
                        Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ (User ID): <br><span id="current-user-id" class="font-mono text-xs break-all text-gray-700"></span>
                    </p>
                </aside>

                <!-- Ù†Ø§Ø­ÛŒÙ‡ Ù…Ø­ØªÙˆØ§ (Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±) -->
                <section class="lg:col-span-3">
                    <div id="content-area">
                        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ -->
                        <div id="default-admin-view" class="bg-white p-8 rounded-xl shadow-lg">
                            <h3 class="text-2xl font-bold text-gray-800 mb-4">Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</h3>
                            <p class="text-gray-600">Ø§Ø² Ù…Ù†ÙˆÛŒ Ú©Ù†Ø§Ø±ÛŒØŒ Ù…Ø§Ú˜ÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ØªØ§ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ø®ØªÙ…Ø§Ù† Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.</p>
                            <p class="mt-4 p-4 bg-yellow-50 border-r-4 border-yellow-500 text-yellow-800 rounded-lg">
                                **Ù…Ù‡Ù…:** Ù‚Ø¨Ù„ Ø§Ø² Ø´Ø±ÙˆØ¹ØŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ù‡ Ø¨Ø®Ø´ **Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ø­Ø¯Ù‡Ø§** Ø¨Ø±ÙˆÛŒØ¯ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ø§Ø®ØªÙ…Ø§Ù† (ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ø­Ø¯Ù‡Ø§ØŒ Ù…ØªØ±Ø§Ú˜ Ùˆ ...) Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.
                            </p>
                        </div>

                        <!-- 1. Ù…Ø§Ú˜ÙˆÙ„ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ùˆ Ù…Ø§Ù„ÛŒ (finance) -->
                        <div id="finance-view" class="view-content hidden bg-white p-8 rounded-xl shadow-lg">
                            <h3 class="text-2xl font-bold text-indigo-700 mb-6 border-b pb-2">ğŸ’° Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ùˆ Ù…Ø§Ù„ÛŒ</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                                    <h4 class="font-semibold text-lg text-green-700 mb-3">Ø«Ø¨Øª Ø´Ø§Ø±Ú˜ Ù…Ø§Ù‡Ø§Ù†Ù‡</h4>
                                    <!-- ÙØ±Ù… Ø«Ø¨Øª Ø´Ø§Ø±Ú˜ -->
                                    <form id="charge-form" class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Ø¹Ù†ÙˆØ§Ù†/Ù…Ø§Ù‡:</label>
                                            <input type="text" id="charge-title" required class="text-input focus:border-indigo-500 focus:ring-indigo-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Ù…Ø¨Ù„Øº Ú©Ù„ Ø´Ø§Ø±Ú˜ (ØªÙˆÙ…Ø§Ù†):</label>
                                            <input type="number" id="charge-amount" required class="text-input focus:border-indigo-500 focus:ring-indigo-500" min="1000">
                                        </div>
                                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                            Ø«Ø¨Øª Ùˆ ØªØ®ØµÛŒØµ Ø´Ø§Ø±Ú˜ Ø¨Ù‡ ÙˆØ§Ø­Ø¯Ù‡Ø§
                                        </button>
                                    </form>
                                </div>
                                <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                                    <h4 class="font-semibold text-lg text-red-700 mb-3">Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ Ù…Ø´ØªØ±Ú©</h4>
                                    <!-- ÙØ±Ù… Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ -->
                                    <form id="expense-form" class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Ø¹Ù†ÙˆØ§Ù† Ù‡Ø²ÛŒÙ†Ù‡:</label>
                                            <input type="text" id="expense-title" required class="text-input focus:border-red-500 focus:ring-red-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Ù…Ø¨Ù„Øº Ù‡Ø²ÛŒÙ†Ù‡ (ØªÙˆÙ…Ø§Ù†):</label>
                                            <input type="number" id="expense-amount" required class="text-input focus:border-red-500 focus:ring-red-500" min="1000">
                                        </div>
                                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                            Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡
                                        </button>
                                    </form>
                                </div>
                            </div>
                            
                            <h4 class="font-bold text-xl text-gray-700 mt-8 mb-4">Ø®Ù„Ø§ØµÙ‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h4>
                            <div id="transactions-list" class="space-y-3">
                                <p class="text-gray-500">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§...</p>
                            </div>

                        </div>

                        <!-- 2. Ù…Ø§Ú˜ÙˆÙ„ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ø­Ø¯Ù‡Ø§ Ùˆ Ø³Ø§Ú©Ù†ÛŒÙ† (units) -->
                        <div id="units-view" class="view-content hidden bg-white p-8 rounded-xl shadow-lg">
                            <h3 class="text-2xl font-bold text-indigo-700 mb-6 border-b pb-2">ğŸ¢ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ø­Ø¯Ù‡Ø§ Ùˆ Ø³Ø§Ú©Ù†ÛŒÙ†</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <h4 class="font-semibold text-lg text-blue-700 mb-3">Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÛŒØ¯</h4>
                                    <!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ø­Ø¯ -->
                                    <form id="unit-form" class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø­Ø¯ (Ù…Ø«Ù„Ø§Ù‹ Û±ØŒ Û±Û°Û±):</label>
                                            <input type="text" id="unit-number" required class="text-input focus:border-indigo-500 focus:ring-indigo-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Ù…ØªØ±Ø§Ú˜ (Ù…ØªØ±Ù…Ø±Ø¨Ø¹):</label>
                                            <input type="number" id="unit-area" required class="text-input focus:border-indigo-500 focus:ring-indigo-500" min="1">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Ù†Ø§Ù… Ø³Ø§Ú©Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
                                            <input type="text" id="resident-name" class="text-input focus:border-indigo-500 focus:ring-indigo-500">
                                        </div>
                                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                            Ø«Ø¨Øª ÙˆØ§Ø­Ø¯
                                        </button>
                                    </form>
                                </div>
                                <div class="p-4">
                                    <h4 class="font-bold text-xl text-gray-700 mb-4">Ù„ÛŒØ³Øª ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</h4>
                                    <div id="units-list" class="space-y-3">
                                        <p class="text-gray-500">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Ù…Ø§Ú˜ÙˆÙ„ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ùˆ Ø¢Ù…Ø§Ø± (reports) -->
                        <div id="reports-view" class="view-content hidden bg-white p-8 rounded-xl shadow-lg">
                            <h3 class="text-2xl font-bold text-indigo-700 mb-6 border-b pb-2">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</h3>

                            <h4 class="font-bold text-xl text-gray-700 mb-4">Ù„ÛŒØ³Øª Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡</h4>
                            <div id="debt-report-list" class="space-y-4">
                                <!-- Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù†Ø¯Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                                <p class="text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡...</p>
                            </div>

                        </div>

                    </div>
                </section>
            </div>
        </div>

        <!-- Ù†Ù…Ø§ÛŒ Ø³Ø§Ú©Ù† (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§) -->
        <div id="resident-view" class="max-w-xl mx-auto hidden">
            <!-- ÙØ±Ù… ÙˆØ±ÙˆØ¯ Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø­Ø¯ -->
            <div id="unit-login-form" class="bg-white p-8 rounded-xl shadow-2xl transition duration-500 transform scale-100">
                <h2 class="text-2xl font-bold text-center mb-6 text-green-700">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙˆØ¶Ø¹ÛŒØª Ø´Ø§Ø±Ú˜ ÙˆØ§Ø­Ø¯</h2>
                <form id="resident-unit-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø­Ø¯ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</label>
                        <input type="text" id="resident-unit-number" required class="text-input focus:border-green-500 focus:ring-green-500">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg">
                        Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§
                    </button>
                    <button id="resident-back-to-role-select" type="button" class="w-full mt-3 text-gray-500 hover:text-gray-700 transition duration-300">
                        Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù‚Ø´
                    </button>
                </form>
            </div>

            <!-- Ø¬Ø¯ÙˆÙ„ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯ -->
            <div id="resident-debt-display" class="hidden bg-white p-8 rounded-xl shadow-2xl">
                <div class="flex justify-between items-center mb-6 border-b pb-2">
                    <h2 class="text-2xl font-bold text-green-700">ÙˆØ¶Ø¹ÛŒØª Ù…Ø§Ù„ÛŒ ÙˆØ§Ø­Ø¯ <span id="display-unit-number"></span></h2>
                    <button id="resident-back-to-form" class="text-sm text-indigo-500 hover:text-indigo-700">ØªØºÛŒÛŒØ± ÙˆØ§Ø­Ø¯</button>
                </div>
                
                <h3 class="text-xl font-semibold mb-4 text-gray-700">Ø´Ø§Ø±Ú˜Ù‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡</h3>
                <div id="resident-unpaid-list" class="space-y-3">
                    <p class="text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</p>
                </div>

                <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-700">Ø´Ø§Ø±Ú˜Ù‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡</h3>
                <div id="resident-paid-list" class="space-y-3">
                    <p class="text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ÛŒ Firebase Ùˆ Ù…Ù†Ø·Ù‚ Ø¨Ø±Ù†Ø§Ù…Ù‡ -->
    <script type="module">
        // ----------------------------------------------------------------------
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Firebase
        // ----------------------------------------------------------------------

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction, Timestamp, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒØ±Ø¨ÛŒØ³
        setLogLevel('Debug');

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ Ú©Ù‡ ØªÙˆØ³Ø· Ù…Ø­ÛŒØ· Canvas ØªØ²Ø±ÛŒÙ‚ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null; 

        // Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ DOM
        const loadingSpinner = document.getElementById('loading-spinner');
        const roleSelectionView = document.getElementById('role-selection-view');
        const adminAuthView = document.getElementById('admin-auth-view');
        const adminDashboardView = document.getElementById('admin-dashboard-view');
        const residentView = document.getElementById('resident-view');
        const unitLoginForm = document.getElementById('unit-login-form');
        const residentDebtDisplay = document.getElementById('resident-debt-display');
        
        const signInButton = document.getElementById('sign-in-button');
        const logoutButton = document.getElementById('logout-button');
        const userDisplay = document.getElementById('user-display');
        const currentUserIdDisplay = document.getElementById('current-user-id');
        const systemMessageBox = document.getElementById('system-message-box');
        const contentArea = document.getElementById('content-area');
        const menuButtons = document.querySelectorAll('.menu-button');
        
        // ÙØ±Ù…â€ŒÙ‡Ø§
        const unitForm = document.getElementById('unit-form');
        const unitsList = document.getElementById('units-list');
        const chargeForm = document.getElementById('charge-form');
        const expenseForm = document.getElementById('expense-form');
        const transactionsList = document.getElementById('transactions-list');
        const residentUnitForm = document.getElementById('resident-unit-form');
        const residentUnpaidList = document.getElementById('resident-unpaid-list');
        const residentPaidList = document.getElementById('resident-paid-list');
        const debtReportList = document.getElementById('debt-report-list');

        // ÙˆØ¶Ø¹ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        let unitsData = []; // Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø³Ø§Ø®ØªÙ…Ø§Ù†
        let allPaymentsData = []; // ØªÙ…Ø§Ù…ÛŒ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ

        let currentResidentUnitId = null; // Ø´Ù†Ø§Ø³Ù‡ ÙˆØ§Ø­Ø¯ÛŒ Ú©Ù‡ Ø³Ø§Ú©Ù† Ø¯Ø± Ø­Ø§Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ù† Ø§Ø³Øª

        // ----------------------------------------------------------------------
        // ØªÙˆØ§Ø¨Ø¹ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ
        // ----------------------------------------------------------------------

        /**
         * Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… (Ù…ÙˆÙÙ‚ÛŒØªØŒ Ø®Ø·Ø§ØŒ Ù‡Ø´Ø¯Ø§Ø±)
         */
        function showSystemMessage(message, type = 'success') {
            // Ù…Ù†Ø·Ù‚ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
            const baseClasses = "p-4 mb-4 rounded-lg text-sm font-medium transition duration-300 ease-in-out";
            let colorClasses = '';

            switch (type) {
                case 'success':
                    colorClasses = 'bg-green-100 text-green-800 border-r-4 border-green-500';
                    break;
                case 'error':
                    colorClasses = 'bg-red-100 text-red-800 border-r-4 border-red-500';
                    break;
                case 'warning':
                    colorClasses = 'bg-yellow-100 text-yellow-800 border-r-4 border-yellow-500';
                    break;
                default:
                    colorClasses = 'bg-gray-100 text-gray-800';
            }

            systemMessageBox.className = `${baseClasses} ${colorClasses}`;
            systemMessageBox.textContent = message;
            systemMessageBox.classList.remove('hidden');

            setTimeout(() => {
                systemMessageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * ÙØ±Ù…Øªâ€ŒØ¯Ù‡ÛŒ Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ù‡ ØµÙˆØ±Øª ØªÙˆÙ…Ø§Ù†
         */
        function formatCurrency(number) {
            if (number === null || typeof number === 'undefined') return 'Û°';
            return new Intl.NumberFormat('fa-IR').format(number) + ' ØªÙˆÙ…Ø§Ù†';
        }
        
        /**
         * Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø³Ø§Ø®ØªÙ…Ø§Ù† (Ù…Ø¯ÛŒØ±)
         */
        function renderUnits(units) {
            unitsList.innerHTML = ''; 
            if (units.length === 0) {
                unitsList.innerHTML = '<p class="text-gray-500 p-4 bg-gray-50 rounded-lg">Ù‡Ù†ÙˆØ² ÙˆØ§Ø­Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</p>';
                return;
            }

            units.forEach(unit => {
                const unitElement = document.createElement('div');
                unitElement.className = 'flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-indigo-50 transition duration-150';
                
                const details = `
                    <div>
                        <p class="font-bold text-indigo-600">ÙˆØ§Ø­Ø¯ ${unit.number}</p>
                        <p class="text-sm text-gray-500">Ù…ØªØ±Ø§Ú˜: ${unit.area} Ù….Ù… | Ø³Ø§Ú©Ù†: ${unit.residentName || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                    </div>
                `;
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-red-500 hover:text-red-700 text-sm font-semibold p-1 transition duration-150';
                deleteButton.textContent = 'Ø­Ø°Ù';
                deleteButton.onclick = () => handleDeleteUnit(unit.id);

                unitElement.innerHTML = details;
                unitElement.appendChild(deleteButton);
                unitsList.appendChild(unitElement);
            });
            unitsData = units.sort((a, b) => {
                // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø­Ø¯
                const numA = parseInt(a.number.replace(/\D/g, ''));
                const numB = parseInt(b.number.replace(/\D/g, ''));
                return numA - numB;
            });
        }

        /**
         * Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ (Ø´Ø§Ø±Ú˜Ù‡Ø§ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§) (Ù…Ø¯ÛŒØ±)
         */
        function renderTransactions(transactions) {
            transactionsList.innerHTML = '';
            
            if (transactions.length === 0) {
                transactionsList.innerHTML = '<p class="text-gray-500 p-4 bg-gray-50 rounded-lg">ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                return;
            }

            // Ø±ÙØ¹ Ø®Ø·Ø§: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø²Ù†Ø¬ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ Ø¯Ø± ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù‡Ù†ÙˆØ² Ø³Ø±ÙˆØ± timestamp Ø¢Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ù†Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ø§Ø³Øª.
            transactions.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

            transactions.forEach(tx => {
                const txElement = document.createElement('div');
                const isCharge = tx.type === 'charge';
                const bgColor = isCharge ? 'bg-green-100 border-green-300' : 'bg-red-100 border-red-300';
                const textColor = isCharge ? 'text-green-800' : 'text-red-800';

                const date = tx.timestamp ? new Date(tx.timestamp.toMillis()).toLocaleDateString('fa-IR') : 'ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø´Ø®Øµ';

                txElement.className = `p-4 rounded-lg border-l-4 ${bgColor} flex justify-between items-center`;
                txElement.innerHTML = `
                    <div>
                        <p class="font-bold ${textColor}">${isCharge ? 'Ø´Ø§Ø±Ú˜ Ù…Ø§Ù‡Ø§Ù†Ù‡' : 'Ù‡Ø²ÛŒÙ†Ù‡ Ù…Ø´ØªØ±Ú©'}: ${tx.title}</p>
                        <p class="text-sm text-gray-600 mt-1">Ù…Ø¨Ù„Øº: ${formatCurrency(tx.amount)}</p>
                        <p class="text-xs text-gray-500">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª: ${date}</p>
                    </div>
                    ${isCharge ? `<span class="text-xs text-indigo-600 font-medium">ØªÙˆØ²ÛŒØ¹ Ø´Ø¯Ù‡ Ø¨Ù‡ ${unitsData.length} ÙˆØ§Ø­Ø¯</span>` : ''}
                `;
                transactionsList.appendChild(txElement);
            });
        }
        
        /**
         * Ø±Ù†Ø¯Ø± Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡ (Ù…Ø¯ÛŒØ±)
         * @param {Array} payments - Ù„ÛŒØ³Øª Ø§Ø³Ù†Ø§Ø¯ Ø¨Ø¯Ù‡ÛŒ
         */
        function renderDebtReport(payments) {
            debtReportList.innerHTML = '';
            
            // ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡
            const unpaidDebts = payments.filter(p => !p.isPaid);
            allPaymentsData = payments; // Ø°Ø®ÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢ØªÛŒ

            if (unpaidDebts.length === 0) {
                debtReportList.innerHTML = '<p class="text-gray-600 p-4 bg-green-50 rounded-lg">Ø¹Ø§Ù„ÛŒ! Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù‡ÛŒÚ† Ø¨Ø¯Ù‡ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
                return;
            }

            unpaidDebts.sort((a, b) => {
                // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø­Ø¯
                const numA = parseInt(a.unitNumber.replace(/\D/g, ''));
                const numB = parseInt(b.unitNumber.replace(/\D/g, ''));
                return numA - numB;
            });
            
            unpaidDebts.forEach(debt => {
                const debtElement = document.createElement('div');
                debtElement.className = 'flex justify-between items-center p-4 bg-red-50 border-r-4 border-red-500 rounded-lg shadow-sm';
                
                const details = `
                    <div>
                        <p class="font-bold text-red-800">ÙˆØ§Ø­Ø¯ ${debt.unitNumber} - ${debt.chargeTitle}</p>
                        <p class="text-lg font-extrabold text-red-600 mt-1">Ù…Ø¨Ù„Øº Ø¨Ø¯Ù‡ÛŒ: ${formatCurrency(debt.amountDue)}</p>
                    </div>
                `;

                const paidButton = document.createElement('button');
                paidButton.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md whitespace-nowrap';
                paidButton.textContent = 'Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª';
                paidButton.onclick = () => handleMarkAsPaid(debt.id, debt.unitNumber, debt.amountDue);

                debtElement.innerHTML = details;
                debtElement.appendChild(paidButton);
                debtReportList.appendChild(debtElement);
            });
        }


        /**
         * Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ ÛŒÚ© ÙˆØ§Ø­Ø¯ Ø®Ø§Øµ (Ø³Ø§Ú©Ù†)
         * @param {Array} payments - Ù„ÛŒØ³Øª Ø§Ø³Ù†Ø§Ø¯ Ø¨Ø¯Ù‡ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ ÙˆØ§Ø­Ø¯
         */
        function renderResidentDebts(payments) {
            residentUnpaidList.innerHTML = '';
            residentPaidList.innerHTML = '';
            
            const unpaid = payments.filter(p => !p.isPaid);
            const paid = payments.filter(p => p.isPaid);
            
            // Ø±Ù†Ø¯Ø± Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡
            if (unpaid.length === 0) {
                residentUnpaidList.innerHTML = '<p class="text-gray-600 p-4 bg-indigo-50 rounded-lg border-l-4 border-indigo-400">Ø¹Ø§Ù„ÛŒ! Ø§ÛŒÙ† ÙˆØ§Ø­Ø¯ Ù‡ÛŒÚ† Ø´Ø§Ø±Ú˜ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡â€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±Ø¯.</p>';
            } else {
                unpaid.forEach(p => {
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-red-100 rounded-lg border-r-4 border-red-500 flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <p class="font-bold text-red-800">${p.chargeTitle}</p>
                            <p class="text-xl font-extrabold text-red-600 mt-1">${formatCurrency(p.amountDue)}</p>
                        </div>
                        <span class="text-sm text-red-600 font-semibold">Ø¨Ø¯Ù‡Ú©Ø§Ø±</span>
                    `;
                    residentUnpaidList.appendChild(el);
                });
            }

            // Ø±Ù†Ø¯Ø± Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡
            if (paid.length === 0) {
                residentPaidList.innerHTML = '<p class="text-gray-600 p-4 bg-gray-50 rounded-lg">Ù‡ÛŒÚ† Ø³Ø§Ø¨Ù‚Ù‡ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
            } else {
                paid.forEach(p => {
                    const paymentDate = p.paymentDate ? new Date(p.paymentDate.toMillis()).toLocaleDateString('fa-IR') : 'ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø´Ø®Øµ';
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-green-100 rounded-lg border-r-4 border-green-500 flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <p class="font-bold text-green-800">${p.chargeTitle}</p>
                            <p class="text-xl font-extrabold text-green-600 mt-1">${formatCurrency(p.amountDue)}</p>
                            <p class="text-xs text-gray-500 mt-1">ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª: ${paymentDate}</p>
                        </div>
                        <span class="text-sm text-green-600 font-semibold">Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</span>
                    `;
                    residentPaidList.appendChild(el);
                });
            }
        }


        // ----------------------------------------------------------------------
        // ØªÙˆØ§Ø¨Ø¹ Ù…Ø³ÛŒØ±Ø¯Ù‡ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ (Routing & View Management)
        // ----------------------------------------------------------------------

        /**
         * Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±
         */
        function switchAdminView(viewId) {
            const views = document.querySelectorAll('.view-content');
            views.forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById('default-admin-view').classList.add('hidden');

            const targetView = document.getElementById(`${viewId}-view`);
            if (targetView) {
                targetView.classList.remove('hidden');
            } else {
                document.getElementById('default-admin-view').classList.remove('hidden');
            }

            menuButtons.forEach(button => {
                if (button.getAttribute('data-view') === viewId) {
                    button.classList.add('bg-indigo-50', 'text-indigo-700');
                    button.classList.remove('text-gray-600', 'hover:bg-gray-50');
                } else {
                    button.classList.remove('bg-indigo-50', 'text-indigo-700');
                    button.classList.add('text-gray-600', 'hover:bg-gray-50');
                }
            });
        }
        
        /**
         * ØªØºÛŒÛŒØ± Ù†Ù…Ø§ÛŒ Ø§ØµÙ„ÛŒ (Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù‚Ø´ØŒ ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±ØŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ØŒ Ù†Ù…Ø§ÛŒ Ø³Ø§Ú©Ù†)
         * @param {'role-select'|'admin-auth'|'admin-dashboard'|'resident'} view 
         */
        function navigateTo(view) {
            roleSelectionView.classList.add('hidden');
            adminAuthView.classList.add('hidden');
            adminDashboardView.classList.add('hidden');
            residentView.classList.add('hidden');
            
            document.getElementById('user-info').classList.add('hidden'); // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ù‡Ø¯Ø± Ú©Ø§Ø±Ø¨Ø±

            if (view === 'role-select') {
                roleSelectionView.classList.remove('hidden');
            } else if (view === 'admin-auth') {
                adminAuthView.classList.remove('hidden');
            } else if (view === 'admin-dashboard') {
                adminDashboardView.classList.remove('hidden');
                document.getElementById('user-info').classList.remove('hidden');
            } else if (view === 'resident') {
                residentView.classList.remove('hidden');
            }
        }
        
        /**
         * ØªØºÛŒÛŒØ± Ù†Ù…Ø§ÛŒ Ø³Ø§Ú©Ù† (ÙØ±Ù… ÙˆØ±ÙˆØ¯ ÙˆØ§Ø­Ø¯ ÛŒØ§ Ø¬Ø¯ÙˆÙ„ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§)
         * @param {'login'|'debts'} view 
         */
        function switchResidentView(view) {
            unitLoginForm.classList.add('hidden');
            residentDebtDisplay.classList.add('hidden');

            if (view === 'login') {
                unitLoginForm.classList.remove('hidden');
                currentResidentUnitId = null;
            } else if (view === 'debts') {
                residentDebtDisplay.classList.remove('hidden');
            }
        }


        // ----------------------------------------------------------------------
        // ØªÙˆØ§Ø¨Ø¹ Firebase Ùˆ Firestore
        // ----------------------------------------------------------------------

        /**
         * Ø³Ø§Ø®Øª Ù…Ø³ÛŒØ± Collection Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ (Collections for public data)
         */
        function getPublicCollectionPath(collectionName) {
            // Ù…Ø³ÛŒØ± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ: /artifacts/{appId}/public/data/{collectionName}
            return `artifacts/${appId}/public/data/${collectionName}`;
        }
        
        /**
         * Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Firebase Ùˆ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª (Ù…Ø®ØµÙˆØµ Ù…Ø¯ÛŒØ±)
         */
        async function initializeAndAuthenticateAdmin() {
            if (!firebaseConfig) {
                showSystemMessage('Ø®Ø·Ø§: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Firebase Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.', 'error');
                return;
            }

            loadingSpinner.classList.remove('hidden');
            try {
                // 1. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ (Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯)
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                }
                
                // 2. Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙˆÚ©Ù† ØªØ²Ø±ÛŒÙ‚â€ŒØ´Ø¯Ù‡
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±ØªØŒ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ù†Ø§Ø´Ù†Ø§Ø³
                    await signInAnonymously(auth);
                }

                // 3. ØªÙ†Ø¸ÛŒÙ… Ø´Ù†ÙˆÙ†Ø¯Ù‡ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
                onAuthStateChanged(auth, (user) => {
                    loadingSpinner.classList.add('hidden');
                    if (user) {
                        userId = user.uid;
                        // ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ù‡Ø± Ú©Ø§Ø±Ø¨Ø±ÛŒ Ú©Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆØ¯ØŒ Ù…Ø¯ÛŒØ± Ø§Ø³Øª. 
                        handleSuccessfulAdminSignIn(user);
                    } else {
                        // Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³ØªØŒ Ø¨Ù‡ ØµÙØ­Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù‚Ø´ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                        navigateTo('role-select');
                    }
                });
                
            } catch (error) {
                loadingSpinner.classList.add('hidden');
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ÛŒØ§ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Firebase:", error);
                showSystemMessage(`Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: ${error.message}`, 'error');
                navigateTo('role-select');
            }
        }

        /**
         * Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø³ Ø§Ø² ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ Ù…Ø¯ÛŒØ±
         */
        function handleSuccessfulAdminSignIn(user) {
            navigateTo('admin-dashboard');
            userDisplay.textContent = `Ù…Ø¯ÛŒØ±: ${userId}`;
            logoutButton.classList.remove('hidden');
            currentUserIdDisplay.textContent = userId;

            // Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±
            startAdminDataListeners();
            switchAdminView('default-admin'); 
            
            showSystemMessage('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯. Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!');
        }
        
        /**
         * Ø®Ø±ÙˆØ¬ Ú©Ø§Ø±Ø¨Ø±
         */
        async function handleSignOut() {
            try {
                await signOut(auth);
                showSystemMessage('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.', 'warning');
                navigateTo('role-select');
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬:", error);
                showSystemMessage(`Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬: ${error.message}`, 'error');
            }
        }

        /**
         * Ø´Ø±ÙˆØ¹ Ø´Ù†ÙˆÙ†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ù„Ø§Ø¯Ø±Ù†Ú¯ Firestore (Ù…Ø®ØµÙˆØµ Ù…Ø¯ÛŒØ±)
         */
        function startAdminDataListeners() {
            if (!db || !userId) return;

            // 1. Ø´Ù†ÙˆÙ†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øª ÙˆØ§Ø­Ø¯Ù‡Ø§ (Units)
            const unitsRef = collection(db, getPublicCollectionPath('units'));
            onSnapshot(unitsRef, (snapshot) => {
                const units = [];
                snapshot.forEach(doc => {
                    units.push({ id: doc.id, ...doc.data() });
                });
                renderUnits(units);
            }, (error) => {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø³Ø§Ø®ØªÙ…Ø§Ù†:", error);
                showSystemMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª ÙˆØ§Ø­Ø¯Ù‡Ø§.', 'error');
            });

            // 2. Ø´Ù†ÙˆÙ†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ (Transactions)
            const txRef = collection(db, getPublicCollectionPath('transactions'));
            onSnapshot(txRef, (snapshot) => {
                const transactions = [];
                snapshot.forEach(doc => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                renderTransactions(transactions);
            }, (error) => {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§:", error);
                showSystemMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§.', 'error');
            });
            
            // 3. Ø´Ù†ÙˆÙ†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øª Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ (Payments) - Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ
            const paymentsRef = collection(db, getPublicCollectionPath('payments'));
            onSnapshot(paymentsRef, (snapshot) => {
                const payments = [];
                snapshot.forEach(doc => {
                    payments.push({ id: doc.id, ...doc.data() });
                });
                renderDebtReport(payments); // Ø±Ù†Ø¯Ø± Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø¯Ù‡ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±
            }, (error) => {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§:", error);
                showSystemMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§.', 'error');
            });
        }


        // ----------------------------------------------------------------------
        // ØªÙˆØ§Ø¨Ø¹ CRUD (Ø§ÛŒØ¬Ø§Ø¯ØŒ Ø®ÙˆØ§Ù†Ø¯Ù†ØŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒØŒ Ø­Ø°Ù)
        // ----------------------------------------------------------------------

        // Ø«Ø¨Øª ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÛŒØ¯ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        unitForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingSpinner.classList.remove('hidden');
            
            const number = document.getElementById('unit-number').value.trim();
            const area = parseInt(document.getElementById('unit-area').value);
            const residentName = document.getElementById('resident-name').value.trim();

            if (!number || isNaN(area) || area <= 0) {
                showSystemMessage('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø­Ø¯ Ùˆ Ù…ØªØ±Ø§Ú˜ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'warning');
                loadingSpinner.classList.add('hidden');
                return;
            }

            try {
                const unitsRef = collection(db, getPublicCollectionPath('units'));
                await addDoc(unitsRef, {
                    number: number,
                    area: area,
                    residentName: residentName,
                    createdAt: serverTimestamp(),
                    managerId: userId 
                });

                showSystemMessage(`ÙˆØ§Ø­Ø¯ Ø´Ù…Ø§Ø±Ù‡ ${number} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.`);
                unitForm.reset();
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ÙˆØ§Ø­Ø¯:", error);
                showSystemMessage(`Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ÙˆØ§Ø­Ø¯: ${error.message}`, 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        // Ø­Ø°Ù ÙˆØ§Ø­Ø¯ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        async function handleDeleteUnit(unitId) {
            loadingSpinner.classList.remove('hidden');
            try {
                const unitDocRef = doc(db, getPublicCollectionPath('units'), unitId);
                await deleteDoc(unitDocRef);
                showSystemMessage('ÙˆØ§Ø­Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.', 'success');
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙˆØ§Ø­Ø¯:", error);
                showSystemMessage(`Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙˆØ§Ø­Ø¯: ${error.message}`, 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        // Ø«Ø¨Øª Ø´Ø§Ø±Ú˜ Ø¬Ø¯ÛŒØ¯ Ùˆ ØªÙˆØ²ÛŒØ¹ Ø¢Ù† (ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        chargeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingSpinner.classList.remove('hidden');

            const title = document.getElementById('charge-title').value.trim();
            const amount = parseInt(document.getElementById('charge-amount').value);

            if (!title || isNaN(amount) || amount <= 0) {
                showSystemMessage('Ù„Ø·ÙØ§Ù‹ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…Ø¨Ù„Øº Ù…Ø¹ØªØ¨Ø± Ø´Ø§Ø±Ú˜ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'warning');
                loadingSpinner.classList.add('hidden');
                return;
            }

            if (unitsData.length === 0) {
                showSystemMessage('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ÙˆØ§Ø­Ø¯ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.', 'warning');
                loadingSpinner.classList.add('hidden');
                return;
            }

            try {
                await runTransaction(db, async (transaction) => {
                    const txRef = collection(db, getPublicCollectionPath('transactions'));
                    const paymentsRef = collection(db, getPublicCollectionPath('payments'));

                    // 1. Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ø´Ø§Ø±Ú˜ Ø§ØµÙ„ÛŒ
                    const newTxRef = doc(txRef);
                    transaction.set(newTxRef, {
                        title: title,
                        amount: amount,
                        type: 'charge', 
                        managerId: userId,
                        timestamp: serverTimestamp(),
                    });

                    // 2. ØªÙˆØ²ÛŒØ¹ Ø´Ø§Ø±Ú˜ Ø¨ÛŒÙ† ÙˆØ§Ø­Ø¯Ù‡Ø§ (ØªÙ‚Ø³ÛŒÙ… Ù…Ø³Ø§ÙˆÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ)
                    const unitShare = Math.round(amount / unitsData.length);
                    
                    unitsData.forEach(unit => {
                        const paymentDocRef = doc(paymentsRef); 
                        transaction.set(paymentDocRef, {
                            unitId: unit.id,
                            unitNumber: unit.number,
                            chargeTitle: title,
                            amountDue: unitShare,
                            isPaid: false, // Ø¨Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡ Ø§Ø³Øª
                            chargeTxId: newTxRef.id,
                            managerId: userId,
                            createdAt: serverTimestamp(),
                        });
                    });
                });

                showSystemMessage(`Ø´Ø§Ø±Ú˜ "${title}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ùˆ ØªÙˆØ²ÛŒØ¹ Ø´Ø¯.`);
                chargeForm.reset();

            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø´Ø§Ø±Ú˜ Ùˆ ØªØ±Ø§Ú©Ù†Ø´:", error);
                showSystemMessage(`Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø´Ø§Ø±Ú˜: ${error.message}`, 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        // Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ Ù…Ø´ØªØ±Ú© Ø³Ø§Ø®ØªÙ…Ø§Ù† (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingSpinner.classList.remove('hidden');
            
            const title = document.getElementById('expense-title').value.trim();
            const amount = parseInt(document.getElementById('expense-amount').value);

            if (!title || isNaN(amount) || amount <= 0) {
                showSystemMessage('Ù„Ø·ÙØ§Ù‹ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…Ø¨Ù„Øº Ù…Ø¹ØªØ¨Ø± Ù‡Ø²ÛŒÙ†Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'warning');
                loadingSpinner.classList.add('hidden');
                return;
            }

            try {
                const txRef = collection(db, getPublicCollectionPath('transactions'));
                await addDoc(txRef, {
                    title: title,
                    amount: amount,
                    type: 'expense', 
                    managerId: userId,
                    timestamp: serverTimestamp(),
                });

                showSystemMessage(`Ù‡Ø²ÛŒÙ†Ù‡ "${title}" Ø¨Ù‡ Ù…Ø¨Ù„Øº ${formatCurrency(amount)} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.`);
                expenseForm.reset();
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡:", error);
                showSystemMessage(`Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡: ${error.message}`, 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        /**
         * Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª (ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ø¯Ù‡ÛŒ Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡)
         * @param {string} paymentId - Ø´Ù†Ø§Ø³Ù‡ Ø³Ù†Ø¯ Ø¨Ø¯Ù‡ÛŒ
         * @param {string} unitNumber - Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø­Ø¯
         * @param {number} amount - Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡
         */
        async function handleMarkAsPaid(paymentId, unitNumber, amount) {
            loadingSpinner.classList.remove('hidden');
            try {
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³Ù†Ø¯ Ø¨Ø¯Ù‡ÛŒ
                const paymentDocRef = doc(db, getPublicCollectionPath('payments'), paymentId);
                await updateDoc(paymentDocRef, {
                    isPaid: true,
                    paymentDate: serverTimestamp(), // Ø«Ø¨Øª Ø²Ù…Ø§Ù† Ù¾Ø±Ø¯Ø§Ø®Øª
                    paidByManagerId: userId // Ø«Ø¨Øª Ø§ÛŒÙ†Ú©Ù‡ Ú©Ø¯Ø§Ù… Ù…Ø¯ÛŒØ± Ø§ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡
                });

                showSystemMessage(`Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø§Ø±Ú˜ ÙˆØ§Ø­Ø¯ ${unitNumber} Ø¨Ù‡ Ù…Ø¨Ù„Øº ${formatCurrency(amount)} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.`, 'success');
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª:", error);
                showSystemMessage(`Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª: ${error.message}`, 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }


        // ----------------------------------------------------------------------
        // Ù…Ù†Ø·Ù‚ Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø§Ú©Ù†ÛŒÙ† (Resident Access Logic)
        // ----------------------------------------------------------------------
        
        /**
         * Ø¬Ø³ØªØ¬ÙˆÛŒ ÙˆØ§Ø­Ø¯ Ø³Ø§Ú©Ù† Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§
         */
        residentUnitForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingSpinner.classList.remove('hidden');

            const unitNumber = document.getElementById('resident-unit-number').value.trim();
            
            if (!unitNumber) {
                showSystemMessage('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø­Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'warning');
                loadingSpinner.classList.add('hidden');
                return;
            }

            try {
                // 1. Ø¬Ø³ØªØ¬ÙˆÛŒ ÙˆØ§Ø­Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ù…Ø§Ø±Ù‡
                const unitsRef = collection(db, getPublicCollectionPath('units'));
                const qUnit = query(unitsRef, where("number", "==", unitNumber));
                const unitSnapshot = await getDocs(qUnit);

                if (unitSnapshot.empty) {
                    showSystemMessage(`ÙˆØ§Ø­Ø¯ Ø´Ù…Ø§Ø±Ù‡ "${unitNumber}" Ø¯Ø± Ø³ÛŒØ³ØªÙ… ÛŒØ§ÙØª Ù†Ø´Ø¯.`, 'error');
                    return;
                }
                
                // ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø­Ø¯ ÛŒÚ©ØªØ§Ø³Øª
                const unitDoc = unitSnapshot.docs[0];
                const unitId = unitDoc.id;
                currentResidentUnitId = unitId;

                // 2. Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ UnitId
                const paymentsRef = collection(db, getPublicCollectionPath('payments'));
                const qPayments = query(paymentsRef, where("unitId", "==", unitId));

                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² onSnapshot Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³Ø§Ú©Ù†
                onSnapshot(qPayments, (snapshot) => {
                    const payments = [];
                    snapshot.forEach(doc => {
                        payments.push({ id: doc.id, ...doc.data() });
                    });
                    
                    document.getElementById('display-unit-number').textContent = unitNumber;
                    renderResidentDebts(payments);
                    switchResidentView('debts'); // ØªØºÛŒÛŒØ± Ø¨Ù‡ Ù†Ù…Ø§ÛŒ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§
                }, (error) => {
                    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³Ø§Ú©Ù†:", error);
                    showSystemMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø¯Ù‡ÛŒ.', 'error');
                });
                
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ ÛŒØ§ Ø§ØªØµØ§Ù„:", error);
                showSystemMessage(`Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…: ${error.message}`, 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });


        // ----------------------------------------------------------------------
        // Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ùˆ Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
        // ----------------------------------------------------------------------

        // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ù†Ùˆ Ù…Ø¯ÛŒØ±
        menuButtons.forEach(button => {
            button.addEventListener('click', () => {
                const view = button.getAttribute('data-view');
                switchAdminView(view);
            });
        });
        
        // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù‚Ø´
        document.getElementById('select-admin').addEventListener('click', () => {
            navigateTo('admin-auth');
        });

        document.getElementById('select-resident').addEventListener('click', () => {
            navigateTo('resident');
            switchResidentView('login');
        });

        document.getElementById('back-to-role-select').addEventListener('click', () => {
            navigateTo('role-select');
        });
        
        document.getElementById('resident-back-to-role-select').addEventListener('click', () => {
            navigateTo('role-select');
        });
        
        document.getElementById('resident-back-to-form').addEventListener('click', () => {
            switchResidentView('login');
            document.getElementById('resident-unit-number').value = ''; // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø­Ø¯
        });


        // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
        signInButton.addEventListener('click', initializeAndAuthenticateAdmin); 
        logoutButton.addEventListener('click', handleSignOut);

        // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§ Ù†Ù…Ø§ÛŒØ´ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù‚Ø´
        window.onload = function() {
            // Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ØŒ Ø³ÛŒØ³ØªÙ… Firebase Ø±Ø§ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´ÛŒØ¡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            }
            
            // ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡: Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù‚Ø´
            navigateTo('role-select');
        }

    </script>
</body>
</html>
